# SimpleSmart Services

Сервисы для системы умного дома:

* **ventService** сервис, управляющий канальным вентилятором по сигналам датчиков температуры и влажности
* **historyCaptureService** сервис, собирающий историю значений датчиков и управляющих сигналов

## Сборка

Для корректной сборки необходимо установить переменную окружения **GO111MODULE=on**. В проекте используется система модулей go. Репозиторий **simpleSmart-Services** выгрузить в любой удобный каталог. Для сборки проекта набрать:

> make

Исполняемые модули будут собраны в подкаталог **bin**.

Иногда для сборки может потребоваться обновить пакет **paho.mqtt.golang** до крайней ревизии его master-ветки. Для этого на **github.com** посмотреть хэш последнего коммита ветки. Напримр, это будет `939f51659320414efe03753fc96228d3ac84e439`. Далее нужно выполнить команду:

> go get github.com/eclipse/paho.mqtt.golang@939f51659320414efe03753fc96228d3ac84e439

После обновления нужно повторить сборку

## Зависимости, необходимые для работы:

* **mosquitto**
* **influxdb**
* **nginx**
* **grafana**

### Настройка mosquitto

Никакой специальной настройки не требуется

### Настройка influxdb

Настройка не оптимальна, потому, что не учитывает размещения на флеш-карте. Частые записи на флеш-карту могут её быстро убить. Подразумевается, что развёртывание будет производиться на raspberry pi.

Далее указаны особенности настройки, в дополнение к тем, что прописаны по умолчанию:

	[meta]
		retention-autocreate = false
		
	[data]
		wal-fsync-delay = "100ms"
		
	[retention]
		enabled = true
		check-interval = "30m"
		
### Настройка nginx

На текущий момент к веб-серверу нет особых требований, поэтому может быть использован любой. У сервера nginx есть особенность работы с тегами `<iframe>`. Для того, чтобы их содержимое отображалось правильно необходимо добавить следующую настройку в файл `/etc/nginx/sites-enabled/default` или его заменяющий:

	server {
		location / {
			proxy_set_header X-Frame-Options "ALLOW-FROM http://";
		}
	}
	
### Настройка grafana

Основное, что нужно настроить - разрешить встраивать графики в `<iframe>`:

	[security]
	allow_embedding = true
	cookie_samesite = none
	
	[auth.anonymous]
	enabled = true
	org_name = Main Org.
	org_role = Viewer
 
## Настройка сервисов simpleSmart

### ventService

### historyCaptureService

